<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <title>Humanity Against Cards</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/lobby.css" rel="stylesheet">
    <link href="assets/css/room.css" rel="stylesheet">
</head>

<body>
<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="javascript:void(0)">Humanity Against Cards</a>
    <button aria-expanded="false" class="navbar-toggler navbar-toggler-right collapsed" data-target="#navb"
            data-toggle="collapse" type="button">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="navbar-collapse collapse" id="navb">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <button class="btn btn-secondary nav-link" data-target="#room-settings" data-toggle="modal" id="createGame"
                        type="button">Create Game
                </button>
            </li>
            <li class="nav-item">
                <button class="btn btn-secondary nav-link" id="refreshGames" onclick="getRooms()">Refresh Games</button>
            </li>
            <li class="nav-item">
                <form class="form-inline my-lg-0">
                    <input class="form-control mr-lg-2" id="search" name="search" oninput="validate()" placeholder="Search"
                           type="text">
                </form>
            </li>
        </ul>

        <ul class="navbar-nav ml-auto" id="authButton">
            <li class="nav-item">
                <a class="nav-link" href="login-register.html">Login/Register</a>
            </li>
        </ul>

        <ul class="navbar-nav ml-auto" id="accountPageButton" style="display: none">
            <li class="nav-item">
                <a class="nav-link" href="account.html">Profile</a>
            </li>
        </ul>

    </div>
</nav>

<div class="modal fade" id="room-settings" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Room Settings</h5>
                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="settings">
                <form action="" onsubmit="return createRoom();" class="room-settings" id="roomSettings" method="post">
                    <fieldset>
                        <p>
                            <label for="score">Score limit</label>
                            <input id="score" name="score_limit" max="999" min="1" required="required" type="number" value="10">
                        </p>
                        <p>
                            <label for="playerLimit">Player limit</label>
                            <input id="playerLimit" name="max_players" max="20" min="3" required="required" type="number" value="3">
                        </p>
                        <p>
                            <label for="spec">Spectator limit</label>
                            <input id="spec" max="20" min="0" required="required" type="number" value="0">
                        </p>
                        <p>
                            <label for="idle">Idle time</label>
                            <input id="idle" max="999" min="1" required="required" type="number" value="10">
                        </p>
                        <p>
                            <label for="lobbyname">Lobby name</label>
                            <input id="lobbyname" name="room_name" required="required" type="text" value="User name's room">
                        </p>
                        <p>
                            <label for="lobbyPassword">Password</label>
                            <input id="lobbyPassword" name="password" placeholder="Enter Password" type="password">
                        </p>
                        <button class="btn btn-success" type="submit">Submit settings</button>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="lobbies" id="lobbies">

</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script>
    let sid = localStorage.getItem("HAC_SID");
    if (sid !== null){
        document.getElementById("authButton").style.display = 'none';
        document.getElementById("accountPageButton").style.display = 'block';
    }
    sid = undefined;

    function getRoomHtml(room) {
        return `
            <div class="card" id="${room.id}">
                <h5 class="card-header" >Room name: ${room.room_name} (${room.players_in_game}/${room.max_players})</h5>
                <div class="card-body">
                    <h5 class="card-title">Players: Player, Player, Player, Player, Player, Player, Player, Player</h5>
                    <h5 class="card-title">Spectators: Player, Player, Player, Player, Player, Player, Player, Player</h5>
                    <h5 class="card-title">Goal: ${room.score_limit} </h5>
                    <p class="card-text">Id: ${room.id}</p>
                    <a class="btn btn-primary" onclick="attemptJoinRoom(${room.id})">Join as Player</a>
                    <a class="btn btn-secondary">Join as Spectator</a>
                </div>
            </div>`;
    }

    function getRooms() {
        fetch('/get_rooms')
            .then(response => response.json())
            .then(function (data) {
                let roomsStr = '';
                if (data["success"] === true) {
                    data["rooms"].forEach(room => roomsStr += getRoomHtml(room));
                }
                document.querySelector(".lobbies").innerHTML = roomsStr;
            })
            .catch(err => console.log(err));
    }
    getRooms();

    function validate() {
        var input, li, i;
        input = document.getElementById('search').value;
        li = document.getElementsByClassName('card');
        // Loop through all list items, and hide those who don't match the search query
        for (i = 0; i < li.length; i++) {
            if (li[i].id.startsWith(input) || input === "") {
                li[i].style.display = "";
            } else {
                li[i].style.display = "none";
            }
        }
    }

    function createRoom(){
        let body = {type: 'create_room'};
        $('#roomSettings').serializeArray().forEach((field) => {
            body[field.name] = field.value;
        });
        console.log("send create", body);
        fetch('rooms', {
            method: 'post',
            headers: {
                "Content-type": "application/json"
            },
            body: JSON.stringify(body)
        })
        .then(res => res.json())
        .then(res=> {
            if (res.success === true)
            {
                alert('Room created');
                getRooms();
            }
            else alert('Failed to create room');
        });
        return false;
    }

    function attemptJoinRoom(id){
        let body = {};
        body.roomID = id;
        body.password = '';

        fetch('/join_room', {
            method: 'post',
            headers: {
                "Content-type": "application/json",
                "session": 'dGs0bXJqOTh1bmRlZmluZWQxNTg4NDEzMjE4ODA4Y3c='
            },
            body: JSON.stringify(body)
        })
        .then(res => res.json())
        .then(res=> {
            if (res.success === true) {
                window.location.href = 'room-' + id;
            }
            else {
                alert('Could not join room');
            }
        });
    }
</script>
</body>
</html>